
<div class="mb-4">
  <div class="flex items-center gap-3">
    <h1 class="text-2xl font-semibold flex-1"><%= @form.title %></h1>
      <%= link_to "Back", forms_path, class: "btn btn-ghost" %>
      <% if current_user&.super_admin? || @form.user_id == current_user&.id %>
        <%= link_to "Edit", edit_form_path(@form), class: "btn btn-secondary" %>
        <%= button_to "Delete", @form, method: :delete, form: { data: { turbo_confirm: 'Are you sure?' } }, class: "btn btn-danger" %>
      <% end %>
    </div>
  </div>
 </div>

<div data-controller="form-show">
<!-- Toasts container for ephemeral messages -->
<div id="flash_toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

<p class="mb-2 text-sm text-slate-600">Created by: <span class="font-medium"><%= @form.user&.email || 'â€”' %></span></p>

<% if @form.public_token.present? %>
  <%= render 'forms/public_link_card', form: @form %>
<% end %>

<div id="fields_table_body">
  <% @form.fields.ordered.each do |field| %>
    <%= render 'fields/builder_card', field: field %>
  <% end %>
</div>
<div id="addQuestionCard" class="mb-6 card max-w-4xl hidden" style="display:none;" data-form-show-target="addQuestionCard">
  <%= render 'fields/add_card_body', field: Field.new(form: @form) %>
  </div>

<!-- Floating + button to open the add-question form -->
<div class="fixed bottom-6 z-10">
  <button id="fabAddQuestion" type="button" aria-expanded="false" aria-controls="addQuestionCard" title="Add field" class="btn btn-primary shadow-lg flex items-center gap-2" data-action="form-show#toggleAddQuestionCard" data-form-show-target="addQuestionFab"><span class="text-lg leading-none">+</span><span>Add field</span></button>
</div>

</div>

<script>
  document.addEventListener('turbo:load', function() {
        // Copy link (inline fallback without Stimulus)
        function copyPublicLink(){
          var input = document.getElementById('publicLinkInput');
          var btn = document.getElementById('copyPublicLink');
          if(!input) return;
          var url = input.value;
          var done = function(){ if(btn){ var old=btn.textContent; btn.textContent='Copied'; setTimeout(function(){ btn.textContent=old; }, 1200); } };
          if(navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(url).then(done).catch(function(){
              input.select(); document.execCommand('copy'); done();
            });
          } else {
            input.select(); document.execCommand('copy'); done();
          }
        }
        document.addEventListener('click', function(e){
          if(e.target && e.target.id === 'copyPublicLink'){ copyPublicLink(); }
        });
    var btn = document.getElementById('fabAddQuestion');
    var card = document.getElementById('addQuestionCard');

    function getForm(){ return document.getElementById('addQuestionForm'); }
    function getTypeSel(){ return document.getElementById('newFieldType'); }
    function getOptsSection(){ return document.getElementById('initialOptionsSection'); }
    function getRepeater(){ return document.getElementById('initialOptionsRepeater'); }

    function hideCard(){ if(card){ card.classList.add('hidden'); card.style.display='none'; } if(btn){ btn.setAttribute('aria-expanded','false'); } }
    function showCard(){ if(card){ card.classList.remove('hidden'); card.style.display=''; setTimeout(function(){ var i=document.getElementById('newFieldLabel'); if(i) i.focus(); },50);} if(btn){ btn.setAttribute('aria-expanded','true'); } toggleOptions(); }
    function toggleOptions(){ var typeSel=getTypeSel(), opts=getOptsSection(); if(!typeSel||!opts) return; if(typeSel.value==='select'){ opts.classList.remove('hidden'); opts.style.display='block'; } else { opts.classList.add('hidden'); opts.style.display='none'; } }

    if(card){ hideCard(); }
    // Ensure all option edit panels start hidden for a consistent UI
    function collapseOptionEditors(){
      try { document.querySelectorAll('.option-edit-panel').forEach(function(p){ p.classList.add('hidden'); p.style.display='none'; }); } catch(e) {}
    }
    collapseOptionEditors();
    if(btn){ btn.addEventListener('click', function(){ var expanded = btn.getAttribute('aria-expanded')==='true'; expanded ? hideCard() : showCard(); }); }

    document.addEventListener('click', function(e){
      var t = e.target;
      if(t && t.id === 'closeAddQuestion'){ hideCard(); }
      // Cancel inside Add option panel: close without navigation
      if(t && t.classList && t.classList.contains('option-cancel')){
        e.preventDefault();
        var root = t.closest && t.closest('[data-controller="toggle"]');
        var panel = root && root.querySelector('[data-toggle-target="toggleable"]');
        if(panel){ panel.classList.add('hidden'); panel.style.display='none';
          // clear inputs inside panel for a clean state next open
          panel.querySelectorAll('input').forEach(function(i){ try{ i.value=''; }catch(_){} });
        }
        return;
      }
      // Toggle the inline "Add option" panel in option new_form partials (Stimulus fallback)
      if(t && t.closest && t.closest('[data-controller="toggle"]')){
        if(t.matches('[data-toggle-target="toggler"]')){
          var root = t.closest('[data-controller="toggle"]');
          var panel = root && root.querySelector('[data-toggle-target="toggleable"]');
          if(panel){
            var hidden = panel.classList.contains('hidden') || panel.style.display==='none';
            if(hidden){ panel.classList.remove('hidden'); panel.style.display=''; }
            else { panel.classList.add('hidden'); panel.style.display='none'; }
          }
          return;
        }
      }
      // Toggle option edit panel via edit icon
      var editBtn = t.closest && t.closest('.option-edit-toggle');
      if(editBtn){
        var id = editBtn.getAttribute('data-option-id');
        var panel = document.getElementById('edit_option_panel_'+id);
        // Close other panels first to keep UI consistent
        document.querySelectorAll('.option-edit-panel').forEach(function(p){ if(p.id !== 'edit_option_panel_'+id){ p.classList.add('hidden'); p.style.display='none'; }});
        if(panel){
          var hidden = panel.classList.contains('hidden');
          if(hidden){ panel.classList.remove('hidden'); panel.style.display=''; }
          else { panel.classList.add('hidden'); panel.style.display='none'; }
        }
        return; // prevent fallthrough
      }
      // Add option
      if(t && (t.matches('[data-action="form-show#addOption"]') || t.classList.contains('add-option'))){
        var repeater = getRepeater(); if(!repeater) return;
        e.preventDefault();
        var idx = repeater.querySelectorAll('.option-row').length;
        var row = document.createElement('div');
        row.className='grid grid-cols-5 gap-2 items-end option-row';
        row.innerHTML = '<div class="col-span-3">\
            <input name="options['+idx+'][label]" class="input" placeholder="e.g. Option '+(idx+1)+'" />\
          </div>\
          <div>\
            <input name="options['+idx+'][value]" class="input" placeholder="value" />\
          </div>\
          <div class="flex gap-2">\
            <button type="button" class="btn btn-secondary add-option">Add</button>\
            <button type="button" class="btn btn-ghost remove-option">Remove</button>\
          </div>';
        repeater.appendChild(row);
      }
      // Remove option
      if(t && (t.matches('[data-action="form-show#removeOption"]') || t.classList.contains('remove-option'))){
        var r = getRepeater(); if(!r) return;
        e.preventDefault();
        var rowEl = t.closest('.option-row');
        var rows = r.querySelectorAll('.option-row');
        if(rowEl && rows.length>1){ rowEl.remove(); }
      }
    });

    document.addEventListener('change', function(e){
      if(e.target && e.target.id === 'newFieldType'){ toggleOptions(); }
    });

    document.addEventListener('turbo:submit-end', function(e){
      var form = getForm();
      if(!form || e.target !== form) return;
      if(e.detail && e.detail.success){
        form.reset();
        hideCard();
        var container = document.getElementById('fields_table_body');
        if(container && container.lastElementChild){ container.lastElementChild.scrollIntoView({behavior:'smooth', block:'center'}); }
        var repeater = getRepeater();
        if(repeater){
          repeater.innerHTML = '<div class="grid grid-cols-5 gap-2 items-end option-row">\
              <div class="col-span-3">\
                <input name="options[0][label]" class="input" placeholder="e.g. Option 1" />\
              </div>\
              <div>\
                <input name="options[0][value]" class="input" placeholder="value" />\
              </div>\
              <div class="flex gap-2">\
                <button type="button" class="btn btn-secondary add-option">Add</button>\
                <button type="button" class="btn btn-ghost remove-option" disabled>Remove</button>\
              </div>\
            </div>';
        }
        toggleOptions();
      }
    });

    // Close option edit panel after successful update
    document.addEventListener('turbo:submit-end', function(e){
      var formEl = e.target;
      if(!(formEl && formEl.classList && formEl.classList.contains('option-edit-form'))) return;
      var id = formEl.getAttribute('data-option-id');
      if(e.detail && e.detail.success){
        var panel = document.getElementById('edit_option_panel_'+id);
        if(panel){ panel.classList.add('hidden'); panel.style.display='none'; }
      }
    });

    // Also collapse option editors around Turbo Stream renders to keep UI consistent
    document.addEventListener('turbo:before-stream-render', function(){ collapseOptionEditors(); });
    document.addEventListener('turbo:render', function(){ collapseOptionEditors(); });
    // Fallback: slight delay collapse to catch any late DOM mutations
    document.addEventListener('turbo:submit-end', function(e){
      // When a field card is replaced on update, ensure editors are collapsed afterwards
      var target = e.target;
      if(target && target.matches('form[action*="/fields/"][method="post"], form[action*="/fields/"][method="patch"], form[action*="/fields/"][data-turbo-stream="true"]')){
        setTimeout(collapseOptionEditors, 50);
      }
    });
  });
</script>
